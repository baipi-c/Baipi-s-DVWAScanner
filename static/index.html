<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Web æ¼æ´æ‰«æå™¨</title>
    <style>
        /* ... ä½ çš„åŸæœ‰ CSS å®Œå…¨ä¸å˜ ... */
        * { box-sizing: border-box; }
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #f9fbfd; color: #333; margin: 0; padding: 0; }
        .container { display: flex; max-width: 1600px; margin: 0 auto; padding: 20px; gap: 20px; }
        .main-panel { flex: 1; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 60, 130, 0.1); padding: 24px; min-width: 0; }
        .sidebar { width: 320px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 60, 130, 0.1); padding: 20px; height: fit-content; max-height: calc(100vh - 40px); overflow-y: auto; position: sticky; top: 20px; }
        h1 { color: #003c82; text-align: center; font-size: 28px; margin-bottom: 8px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 24px; font-size: 16px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #003c82; }
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid #d0e0ff; border-radius: 8px; font-size: 16px; outline: none; transition: border-color 0.3s; }
        input[type="text"]:focus { border-color: #0052cc; box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.15); }
        .scan-types { display: flex; flex-wrap: wrap; gap: 12px; margin: 16px 0; }
        .scan-types label { display: flex; align-items: center; cursor: pointer; font-weight: normal; color: #0052cc; }
        .scan-types input[type="checkbox"] { margin-right: 6px; accent-color: #0052cc; }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
        button { background-color: #0052cc; color: white; border: none; padding: 11px 22px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0, 82, 204, 0.3); }
        button:hover { background-color: #003d99; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 82, 204, 0.4); }
        .log-area { background-color: #f0f7ff; border: 1px solid #cce5ff; border-radius: 8px; padding: 16px; font-family: Consolas, monospace; font-size: 14px; line-height: 1.5; height: 200px; overflow-y: auto; white-space: pre-wrap; color: #003366; margin-top: 16px; }
        .report-section { margin-top: 24px; }
        .report-section h2 { color: #0052cc; margin-bottom: 12px; }
        #report { background: white; border: 1px solid #e0eaff; border-radius: 8px; padding: 16px; font-family: Consolas, monospace; font-size: 13px; white-space: pre; overflow-x: auto; max-height: 300px; }
        .sidebar h2 { color: #0052cc; margin-top: 0; font-size: 20px; }
        .history-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; border-radius: 6px; transition: background 0.2s; }
        .history-item:hover { background-color: #f0f7ff; }
        .history-item strong { color: #003c82; display: block; margin-bottom: 4px; }
        .history-time { color: #666; font-size: 12px; }
        .history-url { color: #0052cc; font-size: 12px; word-break: break-all; }
        @media (max-width: 1100px) {
            .container { flex-direction: column; }
            .sidebar { position: static; width: 100%; max-height: 400px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <h1>Web æ¼æ´æ‰«æå™¨</h1>
            <p class="subtitle">è‡ªåŠ¨åŒ–æ¼æ´æ£€æµ‹ Â· å®æ—¶è¾“å‡º Â· æŠ¥å‘Šç”Ÿæˆ</p>

            <div class="form-group">
                <label for="target">DVWA åœ°å€ï¼ˆå¿…é¡»ä»¥ / ç»“å°¾ï¼‰</label>
                <input type="text" id="target" name="target" placeholder="ä¾‹å¦‚: http://127.0.0.1:8080/dvwa/" value="http://172.19.109.198:8085/">
            </div>

            <div class="scan-types">
                <label><input type="checkbox" name="scan_type" value="SQL æ³¨å…¥"> SQL æ³¨å…¥</label>
                <label><input type="checkbox" name="scan_type" value="XSS åå°„å‹"> XSS åå°„å‹</label>
                <label><input type="checkbox" name="scan_type" value="CSRF"> CSRF</label>
                <label><input type="checkbox" name="scan_type" value="å‘½ä»¤æ³¨å…¥"> å‘½ä»¤æ³¨å…¥</label>
                <label><input type="checkbox" name="scan_type" value="æ–‡ä»¶ä¸Šä¼ "> æ–‡ä»¶ä¸Šä¼ </label>
                <label><input type="checkbox" name="scan_type" value="å…¨éƒ¨æ‰«æ"> å…¨éƒ¨æ‰«æ</label>
            </div>

            <div class="btn-group">
                <button onclick="startScan()">å¼€å§‹æ‰«æ</button>
                <button onclick="clearLog()">æ¸…ç©ºå®æ—¶æ—¥å¿—</button>
            </div>

            <div class="log-area" id="log"></div>

            <div class="report-section">
                <h2>ğŸ“„ æœ¬æ¬¡æ‰«ææŠ¥å‘Š</h2>
                <pre id="report">æ‰«æå®Œæˆåå°†åœ¨æ­¤æ˜¾ç¤º JSON æŠ¥å‘Š...</pre>
            </div>

            <footer style="text-align: center; margin-top: 30px; color: #888; font-size: 14px;">
                Â© 2025 Web æ¼æ´æ‰«æå™¨ Â· å®‰å…¨ç ”ç©¶ä¸“ç”¨
            </footer>
        </div>

        <div class="sidebar">
            <h2>ğŸ•’ æ‰«æå†å²</h2>
            <div id="history-list">
                <p>æš‚æ— å†å²è®°å½•</p>
            </div>
        </div>
    </div>

   <script>
let eventSource = null;
let knownHistoryCount = 0; // ğŸ‘ˆ æ–°å¢ï¼šè®°å½•å·²çŸ¥å†å²æ•°é‡

function startScan() {
    const url = document.getElementById('target').value;
    const checkboxes = document.querySelectorAll('input[name="scan_type"]:checked');
    const scanTypes = Array.from(checkboxes).map(cb => cb.value);

    if (!url || !url.endsWith('/')) {
        alert('DVWA åœ°å€å¿…é¡»ä»¥ / ç»“å°¾');
        return;
    }
    if (scanTypes.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§æ‰«æç±»å‹');
        return;
    }

    fetch('/start_scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, scan_types: scanTypes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('é”™è¯¯: ' + data.error);
            return;
        }

        clearLog();
        appendLog(`[INFO] æ‰«æä»»åŠ¡å·²å¯åŠ¨ï¼ŒID: ${data.task_id}`);

        if (eventSource) {
            eventSource.close();
        }
        eventSource = new EventSource(`/stream/${data.task_id}`);
        eventSource.onmessage = function(event) {
            const msg = JSON.parse(event.data);
            if (msg.line !== undefined) {
                appendLog(msg.line);

                // æ£€æµ‹æ‰«æå®Œæˆï¼Œè‡ªåŠ¨åŠ è½½æŠ¥å‘Š
                if (msg.line.includes('[INFO] æ‰«æå·²å®Œæˆï¼') ||
                    msg.line.includes('å·²ä¿å­˜ SQL æŠ¥å‘Šåˆ°') ||
                    msg.line.includes('æ‰«æå®Œæˆ')) {
                    setTimeout(() => {
                        loadReportByTaskId(data.task_id);
                    }, 500);
                }
            } else if (msg.end) {
                appendLog('[INFO] æ‰«ææµç»“æŸ');
                eventSource.close();
                eventSource = null;
            }
        };
        eventSource.onerror = function() {
            appendLog('[ERROR] SSE è¿æ¥å¼‚å¸¸');
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        };
    })
    .catch(err => {
        console.error('å¯åŠ¨æ‰«æå¤±è´¥:', err);
        alert('è¯·æ±‚å¤±è´¥: ' + err.message);
    });
}

function appendLog(line) {
    const logDiv = document.getElementById('log');
    if (!logDiv) return;
    const p = document.createElement('p');
    p.textContent = line;
    p.style.margin = '2px 0';
    p.style.fontFamily = 'monospace';
    p.style.fontSize = '14px';
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
}

function clearLog() {
    const logDiv = document.getElementById('log');
    if (logDiv) logDiv.innerHTML = '';
}

// ==================== æŠ¥å‘Šæ¸²æŸ“æ ¸å¿ƒå‡½æ•° ====================
function renderReport(reportObj, preElement) {
    let output = '';

    if (reportObj.sql_injection) {
        const sql = reportObj.sql_injection;
        output += `ã€SQL æ³¨å…¥æ£€æµ‹ç»“æœã€‘\n`;
        output += `ç›®æ ‡ URL: ${sql.scan_summary?.target_url || 'N/A'}\n`;
        output += `æ¼æ´æ•°é‡: ${sql.scan_summary?.total_vulnerabilities || sql.vulnerabilities?.length || 0}\n\n`;
        (sql.vulnerabilities || []).forEach((v, i) => {
            output += `æ¼æ´ #${i + 1}\n`;
            output += `  å‚æ•°: ${v.parameter || 'N/A'}\n`;
            output += `  Payload: ${v.payload || 'N/A'}\n`;
            output += `  æ•°æ®åº“: ${v.db_type || 'N/A'}\n`;
            output += `  ç½®ä¿¡åº¦: ${v.confidence || 'N/A'}\n\n`;
        });
        if (sql.recommendations) {
            output += `å®‰å…¨å»ºè®®:\n${sql.recommendations.map(r => `- ${r}`).join('\n')}\n`;
        }
        output += '\n' + '='.repeat(50) + '\n\n';
    }

    if (reportObj.xss) {
        const xss = reportObj.xss;
        output += `ã€XSS åå°„å‹æ£€æµ‹ç»“æœã€‘\n`;
        output += `æ¼æ´æ•°é‡: ${(xss.vulnerabilities || []).length}\n\n`;
        (xss.vulnerabilities || []).forEach((v, i) => {
            output += `æ¼æ´ #${i + 1}\n`;
            output += `  ç±»å‹: ${v.type || 'N/A'}\n`;
            output += `  Payload: ${v.payload || 'N/A'}\n`;
            output += `  ä¸Šä¸‹æ–‡: ${v.context || 'N/A'}\n`;
            output += `  ç½®ä¿¡åº¦: ${v.confidence || 'N/A'}\n`;
            if (v.parameter) output += `  å‚æ•°: ${v.parameter}\n`;
            output += `\n`;
        });
        if (xss.recommendations) {
            output += `å®‰å…¨å»ºè®®:\n${xss.recommendations.map(r => `- ${r}`).join('\n')}\n`;
        }
        output += '\n' + '='.repeat(50) + '\n\n';
    }

    if (reportObj.csrf) {
        const csrf = reportObj.csrf;
        output += `ã€CSRF æ¼æ´æ£€æµ‹ç»“æœã€‘\n`;
        output += `ç›®æ ‡ URL: ${csrf.target_url || 'N/A'}\n`;
        output += `æ˜¯å¦å¯åˆ©ç”¨: ${csrf.is_exploitable ? 'æ˜¯' : 'å¦'}\n`;
        if (csrf.poc_html) {
            output += `PoC HTML:\n${csrf.poc_html}\n\n`;
        }
        if (csrf.recommendations) {
            output += `å®‰å…¨å»ºè®®:\n${csrf.recommendations.map(r => `- ${r}`).join('\n')}\n`;
        }
        output += '\n' + '='.repeat(50) + '\n\n';
    }

    if (reportObj.command_injection) {
        const cmd = reportObj.command_injection;
        output += `ã€å‘½ä»¤æ³¨å…¥æ£€æµ‹ç»“æœã€‘\n`;
        output += `ç›®æ ‡ URL: ${cmd.target_url || 'N/A'}\n`;
        output += `æµ‹è¯•è½½è·æ•°: ${cmd.payloads_tested || 'N/A'}\n`;
        output += `å‘ç°æ³¨å…¥ç‚¹: ${cmd.injection_points_found || 'N/A'}\n`;
        output += `æ¼æ´æ•°é‡: ${cmd.total_vulnerabilities || 'N/A'}\n\n`;
        (cmd.vulnerabilities || []).forEach((v, i) => {
            output += `æ¼æ´ #${i + 1}\n`;
            output += `  Payload: ${v.payload || 'N/A'}\n`;
            output += `  ç±»åˆ«: ${v.category || 'N/A'}\n`;
            output += `  å“åº”è¯æ®: ${Array.isArray(v.evidence) ? v.evidence.join(', ') : v.evidence || 'N/A'}\n`;
            output += `  æ“ä½œç³»ç»Ÿ: ${v.os_type || 'N/A'}\n\n`;
        });
        if (cmd.recommendations) {
            output += `å®‰å…¨å»ºè®®:\n${cmd.recommendations.map(r => `- ${r}`).join('\n')}\n`;
        }
        output += '\n' + '='.repeat(50) + '\n\n';
    }

    if (reportObj.file_upload) {
        const fu = reportObj.file_upload;
        output += `ã€æ–‡ä»¶ä¸Šä¼ æ¼æ´æ£€æµ‹ç»“æœã€‘\n`;
        if (fu.upload_successful !== undefined) {
            output += `ä¸Šä¼ æˆåŠŸ: ${fu.upload_successful ? 'æ˜¯' : 'å¦'}\n`;
        }
        if (fu.uploaded_file_url) {
            output += `ä¸Šä¼ æ–‡ä»¶URL: ${fu.uploaded_file_url}\n`;
        }
        if (fu.tested_extensions) {
            output += `æµ‹è¯•æ‰©å±•å: ${fu.tested_extensions.join(', ')}\n`;
        }
        if (fu.recommendations) {
            output += `å®‰å…¨å»ºè®®:\n${fu.recommendations.map(r => `- ${r}`).join('\n')}\n`;
        }
        output += '\n' + '='.repeat(50) + '\n\n';
    }

    const knownKeys = ['sql_injection', 'xss', 'csrf', 'command_injection', 'file_upload'];
    const unknownKeys = Object.keys(reportObj).filter(k => !knownKeys.includes(k));
    if (unknownKeys.length > 0) {
        output += `ã€æœªçŸ¥æ¼æ´ç±»å‹æŠ¥å‘Šã€‘\n`;
        unknownKeys.forEach(key => {
            output += `${key}:\n${JSON.stringify(reportObj[key], null, 2)}\n\n`;
        });
    }

    if (preElement) {
        preElement.textContent = output.trim() || 'æœªç”Ÿæˆæœ‰æ•ˆæŠ¥å‘Šå†…å®¹ã€‚';
    }
}

function loadReportByTaskId(taskId) {
    fetch(`/history/${taskId}`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            const reportPre = document.getElementById('report');
            if (!reportPre) return;

            if (data.report) {
                try {
                    const reportObj = JSON.parse(data.report);
                    renderReport(reportObj, reportPre);
                } catch (e) {
                    console.warn('æŠ¥å‘Šéæ ‡å‡†JSONï¼Œç›´æ¥æ˜¾ç¤ºåŸæ–‡');
                    reportPre.textContent = data.report;
                }
            } else {
                reportPre.textContent = 'æ‰«æå·²å®Œæˆï¼Œä½†æœªç”Ÿæˆç»“æ„åŒ–æŠ¥å‘Šã€‚';
            }
        })
        .catch(err => {
            console.warn('è‡ªåŠ¨åŠ è½½æŠ¥å‘Šå¤±è´¥ï¼ˆå¯èƒ½å°šæœªä¿å­˜ï¼‰:', err.message);
            const reportPre = document.getElementById('report');
            if (reportPre) reportPre.textContent = 'æŠ¥å‘Šç”Ÿæˆä¸­...';
        });
}

// ==================== åŠ è½½å†å²åˆ—è¡¨ ====================
function loadHistory() {
    const historyList = document.getElementById('history-list');
    if (!historyList) {
        console.warn('âš ï¸ é¡µé¢ç¼ºå°‘ id="history-list" å…ƒç´ ï¼Œå†å²è®°å½•æ— æ³•æ˜¾ç¤º');
        return;
    }

    fetch('/history')
        .then(response => {
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
        })
        .then(data => {
            let records = Array.isArray(data) ? data : [];
            knownHistoryCount = records.length; // ğŸ‘ˆ æ›´æ–°å·²çŸ¥æ•°é‡

            if (records.length === 0) {
                historyList.innerHTML = '<p>æš‚æ— å†å²è®°å½•</p>';
                return;
            }

            let html = '';
            records.forEach(rec => {
                const id = rec.id || 'unknown';
                const time = rec.time || 'æœªçŸ¥æ—¶é—´';
                const target = rec.target_url || 'æœªçŸ¥ç›®æ ‡';
                const types = Array.isArray(rec.scan_types) ? rec.scan_types : ['æœªçŸ¥'];

                html += `
                    <div style="margin-bottom: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px; font-size: 13px;">
                        <small>${time}</small><br>
                        <strong>${target}</strong><br>
                        ç±»å‹: ${types.join(', ')}<br>
                        <button onclick="showHistoryDetail('${id}')"
                                style="margin-top: 5px; padding: 3px 8px; font-size: 12px;">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                `;
            });
            historyList.innerHTML = html;
        })
        .catch(err => {
            console.error('âŒ åŠ è½½å†å²è®°å½•å¤±è´¥:', err);
            historyList.innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥: ${err.message}</p>`;
        });
}

// ==================== è‡ªåŠ¨æ£€æŸ¥æ–°å†å²è®°å½•ï¼ˆæ ¸å¿ƒæ–°å¢ï¼‰====================
async function autoCheckHistory() {
    try {
        const res = await fetch('/history');
        const records = await res.json();
        const currentCount = Array.isArray(records) ? records.length : 0;

        if (currentCount !== knownHistoryCount) {
            console.log('ğŸ” æ£€æµ‹åˆ°æ–°æ‰«æè®°å½•ï¼Œè‡ªåŠ¨æ›´æ–°å†å²åˆ—è¡¨');
            loadHistory(); // ä¼šè‡ªåŠ¨æ›´æ–° knownHistoryCount
        }
    } catch (err) {
        console.warn('è‡ªåŠ¨æ£€æŸ¥å†å²å¤±è´¥:', err);
    }
}

// ==================== æŸ¥çœ‹å†å²è¯¦æƒ… ====================
function showHistoryDetail(scanId) {
    if (!scanId || scanId === 'unknown') {
        alert('æ— æ•ˆçš„å†å²è®°å½•ID');
        return;
    }

    clearLog();
    const reportPre = document.getElementById('report');
    if (reportPre) reportPre.textContent = 'æ­£åœ¨åŠ è½½...';

    fetch(`/history/${scanId}`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            const logLines = (data.log || '').split('\n');
            logLines.forEach(line => {
                if (line.trim()) {
                    appendLog(line);
                }
            });

            const reportPre = document.getElementById('report');
            if (reportPre && data.report) {
                try {
                    const reportObj = JSON.parse(data.report);
                    renderReport(reportObj, reportPre);
                } catch (e) {
                    console.warn('æŠ¥å‘Šè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸæ–‡');
                    reportPre.textContent = data.report;
                }
            } else if (reportPre) {
                reportPre.textContent = 'âš ï¸ æ— æŠ¥å‘Šå†…å®¹';
            }
        })
        .catch(err => {
            console.error('åŠ è½½å†å²è¯¦æƒ…å¤±è´¥:', err);
            appendLog(`âŒ åŠ è½½å¤±è´¥: ${err.message}`);
            const reportPre = document.getElementById('report');
            if (reportPre) reportPre.textContent = 'åŠ è½½å¤±è´¥';
        });
}

// ===== åˆå§‹åŒ– =====
window.loadHistory = loadHistory;

document.addEventListener('DOMContentLoaded', () => {
    loadHistory(); // é¦–æ¬¡åŠ è½½
    setInterval(autoCheckHistory, 2000); // ğŸ‘ˆ æ¯2ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
});
</script>
</body>
</html>