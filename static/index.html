<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Web æ¼æ´æ‰«æå™¨</title>
    <style>
        /* ... ä½ çš„åŸæœ‰ CSS å®Œå…¨ä¸å˜ ... */
        * { box-sizing: border-box; }
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #f9fbfd; color: #333; margin: 0; padding: 0; }
        .container { display: flex; max-width: 1600px; margin: 0 auto; padding: 20px; gap: 20px; }
        .main-panel { flex: 1; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 60, 130, 0.1); padding: 24px; min-width: 0; }
        .sidebar { width: 320px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 60, 130, 0.1); padding: 20px; height: fit-content; max-height: calc(100vh - 40px); overflow-y: auto; position: sticky; top: 20px; }
        h1 { color: #003c82; text-align: center; font-size: 28px; margin-bottom: 8px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 24px; font-size: 16px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #003c82; }
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid #d0e0ff; border-radius: 8px; font-size: 16px; outline: none; transition: border-color 0.3s; }
        input[type="text"]:focus { border-color: #0052cc; box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.15); }
        .scan-types { display: flex; flex-wrap: wrap; gap: 12px; margin: 16px 0; }
        .scan-types label { display: flex; align-items: center; cursor: pointer; font-weight: normal; color: #0052cc; }
        .scan-types input[type="checkbox"] { margin-right: 6px; accent-color: #0052cc; }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
        button { background-color: #0052cc; color: white; border: none; padding: 11px 22px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0, 82, 204, 0.3); }
        button:hover { background-color: #003d99; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 82, 204, 0.4); }
        .log-area { background-color: #f0f7ff; border: 1px solid #cce5ff; border-radius: 8px; padding: 16px; font-family: Consolas, monospace; font-size: 14px; line-height: 1.5; height: 200px; overflow-y: auto; white-space: pre-wrap; color: #003366; margin-top: 16px; }
        .report-section { margin-top: 24px; }
        .report-section h2 { color: #0052cc; margin-bottom: 12px; }
        #report { background: white; border: 1px solid #e0eaff; border-radius: 8px; padding: 16px; font-family: Consolas, monospace; font-size: 13px; white-space: pre; overflow-x: auto; max-height: 300px; }
        .sidebar h2 { color: #0052cc; margin-top: 0; font-size: 20px; }
        .history-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; border-radius: 6px; transition: background 0.2s; }
        .history-item:hover { background-color: #f0f7ff; }
        .history-item strong { color: #003c82; display: block; margin-bottom: 4px; }
        .history-time { color: #666; font-size: 12px; }
        .history-url { color: #0052cc; font-size: 12px; word-break: break-all; }
        @media (max-width: 1100px) {
            .container { flex-direction: column; }
            .sidebar { position: static; width: 100%; max-height: 400px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <h1>Web æ¼æ´æ‰«æå™¨</h1>
            <p class="subtitle">è‡ªåŠ¨åŒ–æ¼æ´æ£€æµ‹ Â· å®æ—¶è¾“å‡º Â· æŠ¥å‘Šç”Ÿæˆ</p>

            <div class="form-group">
                <label for="target">DVWA åœ°å€ï¼ˆå¿…é¡»ä»¥ / ç»“å°¾ï¼‰</label>
                <input type="text" id="target" name="target" placeholder="ä¾‹å¦‚: http://127.0.0.1:8080/dvwa/" value="http://172.19.109.198:8085/">
            </div>

            <div class="scan-types">
                <label><input type="checkbox" name="scan_type" value="SQL æ³¨å…¥"> SQL æ³¨å…¥</label>
                <label><input type="checkbox" name="scan_type" value="XSS åå°„å‹"> XSS åå°„å‹</label>
                <label><input type="checkbox" name="scan_type" value="CSRF"> CSRF</label>
                <label><input type="checkbox" name="scan_type" value="å‘½ä»¤æ³¨å…¥"> å‘½ä»¤æ³¨å…¥</label>
                <label><input type="checkbox" name="scan_type" value="æ–‡ä»¶ä¸Šä¼ "> æ–‡ä»¶ä¸Šä¼ </label>
                <label><input type="checkbox" name="scan_type" value="å…¨éƒ¨æ‰«æ"> å…¨éƒ¨æ‰«æ</label>
            </div>

            <div class="btn-group">
                <button onclick="startScan()">å¼€å§‹æ‰«æ</button>
                <button onclick="clearLog()">æ¸…ç©ºå®æ—¶æ—¥å¿—</button>
            </div>

            <div class="log-area" id="log"></div>

            <div class="report-section">
                <h2>ğŸ“„ æœ¬æ¬¡æ‰«ææŠ¥å‘Š</h2>
                <pre id="report">æ‰«æå®Œæˆåå°†åœ¨æ­¤æ˜¾ç¤º JSON æŠ¥å‘Š...</pre>
            </div>

            <footer style="text-align: center; margin-top: 30px; color: #888; font-size: 14px;">
                Â© 2025 Web æ¼æ´æ‰«æå™¨ Â· å®‰å…¨ç ”ç©¶ä¸“ç”¨
            </footer>
        </div>

        <div class="sidebar">
            <h2>ğŸ•’ æ‰«æå†å²</h2>
            <div id="history-list">
                <p>æš‚æ— å†å²è®°å½•</p>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;

        function startScan() {
            if (eventSource) {
                eventSource.close();
            }

            const target = document.getElementById('target').value.trim();
            if (!target.endsWith('/')) {
                alert('DVWA åœ°å€å¿…é¡»ä»¥ / ç»“å°¾ï¼');
                return;
            }

            const checkboxes = document.querySelectorAll('input[name="scan_type"]:checked');
            const scanTypes = Array.from(checkboxes).map(cb => cb.value);

            if (scanTypes.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§æ‰«æç±»å‹ï¼');
                return;
            }

            document.getElementById('log').textContent = '';
            document.getElementById('report').textContent = 'æ‰«æè¿›è¡Œä¸­...';

            fetch('/start_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: target, scan_types: scanTypes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // å¯åŠ¨ SSE æµ
                eventSource = new EventSource(`/stream/${data.task_id}`);
                eventSource.onmessage = function(e) {
                    const msg = JSON.parse(e.data);
                    const logDiv = document.getElementById('log');

                    if (msg.line !== undefined) {
                        logDiv.textContent += msg.line + '\n';
                        logDiv.scrollTop = logDiv.scrollHeight;
                    }

                    if (msg.report !== undefined) {
                        document.getElementById('report').textContent = msg.report;
                    }

                    if (msg.end) {
                        eventSource.close();
                        loadHistoryList(); // åˆ·æ–°å†å²
                    }

                    if (msg.error) {
                        logDiv.textContent += '[ERROR] ' + msg.error + '\n';
                        logDiv.scrollTop = logDiv.scrollHeight;
                    }
                };

                eventSource.onerror = function() {
                    console.log('SSE è¿æ¥å¼‚å¸¸');
                    if (eventSource.readyState === EventSource.CLOSED) {
                        eventSource = null;
                    }
                };
            })
            .catch(err => {
                document.getElementById('log').textContent += '\n[ERROR] å¯åŠ¨å¤±è´¥: ' + err.message;
            });
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function loadHistoryList() {
            fetch('/history')
                .then(r => r.json())
                .then(records => {
                    const listDiv = document.getElementById('history-list');
                    if (records.length === 0) {
                        listDiv.innerHTML = '<p>æš‚æ— å†å²è®°å½•</p>';
                        return;
                    }
                    listDiv.innerHTML = records.map(rec => `
                        <div class="history-item" onclick="viewHistory('${rec.id}')">
                            <strong>${rec.scan_types.join(', ')}</strong>
                            <div class="history-time">${rec.time}</div>
                            <div class="history-url">${rec.target_url}</div>
                        </div>
                    `).join('');
                });
        }

        function viewHistory(scanId) {
            fetch(`/history/${scanId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        alert('è®°å½•ä¸å­˜åœ¨');
                        return;
                    }
                    document.getElementById('log').textContent = data.log || '';
                    document.getElementById('report').textContent = data.report || '';
                });
        }

        window.addEventListener('load', loadHistoryList);
        window.addEventListener('beforeunload', () => {
            if (eventSource) eventSource.close();
        });
    </script>
</body>
</html>